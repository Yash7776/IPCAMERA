<!DOCTYPE html>
<html>
<head>
  <title>Test Camera Monitoring Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    .camera-card {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 15px;
      position: relative;
    }
    .delete-icon {
      position: absolute;
      top: 5px;
      right: 10px;
      cursor: pointer;
      color: red;
      font-size: 18px;
      display: none;
    }
    .camera-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
    .online-status {
      height: 12px;
      width: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }
    .online { background-color: green; }
    .offline { background-color: red; }
  </style>
</head>
<body class="bg-light">

  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>üì∑ Camera Monitoring Dashboard</h2>
      <div>
        <button class="btn btn-success me-2" onclick="showAddModal()">‚ûï Add New IP</button>
        <button class="btn btn-danger" onclick="toggleDeleteMode()">üóëÔ∏è Remove IP</button>
      </div>
    </div>

    {% regroup cameras by location_name as grouped_cameras %}
    {% for group in grouped_cameras %}
      <div class="mb-4">
        <h4 class="border-bottom pb-2">{{ group.grouper }}</h4>
        <div class="camera-grid">
          {% for cam in group.list %}
            <div class="camera-card">
              <span class="delete-icon" onclick="confirmDelete({{ cam.camera_id }}, '{{ cam.location_name }}')">‚ùå</span>
              <video id="video{{ cam.camera_id }}" width="100%" controls autoplay muted></video>
              <div class="mt-2">
                <span class="online-status {% if cam.status == 1 %}online{% else %}offline{% endif %}"></span>
                <strong>Cam {{ cam.camera_id }}</strong>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Add New Camera Modal -->
  <div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
      <form method="POST" action="{% url 'add_camera' %}" class="modal-content">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Add New Camera</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3"><label>Camera Name (Area)</label><input type="text" name="location_name" class="form-control" required></div>
          <div class="mb-3"><label>IP Link (Without rtsp://)</label><input type="text" name="ip_link" class="form-control" required></div>
          <div class="mb-3"><label>Username</label><input type="text" name="user_name" class="form-control" required></div>
          <div class="mb-3"><label>Password</label><input type="password" name="password" class="form-control" required></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Add</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Confirm Delete</h5></div>
        <div class="modal-body">
          <p id="deleteText"></p>
        </div>
        <div class="modal-footer">
          <a id="deleteConfirmBtn" class="btn btn-danger">Yes, Delete</a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Keep</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS Includes -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Initialize HLS.js for each camera
    {% for cam in cameras %}
      (function() {
        const video = document.getElementById("video{{ cam.camera_id }}");
        const url = "/media/stream/cam_{{ cam.camera_id }}.m3u8";
        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(url);
          hls.attachMedia(video);
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = url;
        }
      })();
    {% endfor %}

    function showAddModal() {
      new bootstrap.Modal(document.getElementById('addModal')).show();
    }

    function toggleDeleteMode() {
      document.querySelectorAll('.delete-icon').forEach(icon => {
        icon.style.display = icon.style.display === 'block' ? 'none' : 'block';
      });
    }

    function confirmDelete(camId, location) {
      document.getElementById("deleteText").innerText = `Are you sure you want to delete Camera ${camId} from ${location}?`;
      document.getElementById("deleteConfirmBtn").href = `/delete_camera/${camId}/`;
      new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }
  </script>

</body>
</html>
